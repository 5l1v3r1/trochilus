---
layout: post
title: "春雨医生的技术实践"
date: 2013-06-18 14:08
comments: true
categories: [开发]
---
[春雨医生](http://chunyuyisheng.com/)CTO曾柏毅分享了他们创业过程中的一些实践。从技术角度看，春雨医生核心包括两个客户端，春雨掌上医生以及医生专用版，另外也通过Web提供基本的产品功能。

## 整体结构
![春雨整体结构](/attachments/images/chunyudotme.png)

### PUSH服务
移动互联网公司都绕不开的一个问题是PUSH服务。春雨采用的是Nginx官方的[nginx push stream module](http://wiki.nginx.org/HttpPushStreamModule)解决方案。对于该服务，春雨做压力测试时，PUSH服务同时连接数接近10万时，用于打压的测试机器就崩溃了。在生产环境下，春雨的PUSH服务支持十多万的并发连接，再往上的话，服务稳定性会受到影响。曾柏毅认为合理配置的情况下，单机支持100万并发连接不困难，“但现在没时间专门搞这个”。

关于PUSH服务，春雨也考虑过使用第三方的，例如百度、以及[极光推送](https://www.jpush.cn/)。后来考虑到自身对于PUSH服务的依赖很重、实现PUSH服务的成本也谈不上特别高，为了能更好的对服务质量进行控制，春雨最终放弃了使用第三方服务的想法。

### 应用服务器
春雨的接入层使用Nginx，业务逻辑使用Python（框架选用[Django](https://www.djangoproject.com/)），通过uWSGI使之配合工作。

选用Python和Django主要是开发速度快。春雨刚创办的头两个月内，只有曾柏毅和另外一个核心开发人员，这种情况下，快速出活的语言、框架自然是被欢迎的。“比如说Django自带强大的admin功能，对于数据库管理维护都很方便，不用再额外开发支持系统，包括数据库外键、约束等等都能方便搞定”。春雨掌上医生客户端包含资讯信息服务，这些内容就是运营同事直接通过admin功能录入的。再比如用户登录服务，春雨也是直接使用Django内置的Session中间件。

目前春雨的核心应用服务部署在一台机器上，包括iOS和Android使用的Api接口以及内部人员使用的管理接口。只有一台服务器的一个问题是，当程序升级时，虽然有所谓的elegant upgrade，但升级过程中用户的请求还是会受到一定的影响。

春雨内部还有一个自己写的数据统计系统，主要从MySQL的从库以及第三方统计服务是flurry读取统计数据并显示。另外春雨也有一些自己编写的代码会从服务器的log中分析需要的数据。

### MySQL、Memcached
目前春雨的大部分数据都是保存在MySQL里面，利用Memcached来做缓存。曾柏毅提到，在创业早期，Memcached都没用，MySQL就足够了。另外，为了保证数据可靠性，春雨对MySQL做了master-slave配置，同时还会定期将slave的数据dump出来保存在异地机房的服务器上。slave服务器还会为数据统计系统提供只读服务。

### 文件存储
春雨客户端是支持用户通过语音和图片进行通讯的。用户发布的语音以及图片都是加密后直接存储在服务器文件系统上，这些文件目前大概几百G，每天增加的量目前以MB为单位。服务器做了RAID 1，所以也不太担心文件丢失的问题。曾柏毅提到iOS和Android系统采集的音频格式不是一样的，所以在服务器端统一使用ffmpeg转换为mp3格式。这一转换过程有封装好的python lib，其原理是启动一个ffmpeg进程来做转换。

### 第三方服务
春雨使用flurry来做数据统计。使用[监控宝](http://www.jiankongbao.com/invite/x2vfgy)付费服务来对服务器进行监控，春雨的服务器对监控宝开放了SNMP接口。另外春雨使用[testin](http://www.testin.cn/)来测试Android客户端。

曾柏毅另外提到春雨使用[又拍云](https://www.upyun.com/)来做客户端文件服务器，因为每次发布新版本，Android客户端的下载流量很高，自己host这些文件会带来带宽上的成本，而且用户下载速度也不快。

## 下一步工作
用户量逐渐增加，服务器的压力也逐渐增加。接下来春雨会在服务性能优化上投入一些力量，计划中的包括提高PUSH服务器的处理能力，以及引入Redis改善Django内置的Session机制的性能。

## 团队及工作方式
目前春雨开发者共9个人，服务器端、iOS端和Android端各3个人。使用SVN管理代码，使用Review Board来Review代码，使用[Redmine](http://redmine.org)做项目管理和Bug跟踪。春雨最初使用[Moin Wiki](http://moinmo.in/)做文档管理，后来逐渐迁移到Redmine自带的wiki系统上来了。

春雨一直在寻找优秀人才。曾柏毅提到下半年春雨会重点进行校园招聘，有兴趣的同学们可以考虑一下。
